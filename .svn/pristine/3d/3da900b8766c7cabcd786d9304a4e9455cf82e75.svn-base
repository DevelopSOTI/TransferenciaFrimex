using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
using System.Data.SqlClient;
using System.Data;

namespace FrimexTransferencia
{
    class CTransferencias
    {
        public DataTable VerTransferencias(string ESTATUS,DateTime FInicio,DateTime FFin,out string msg)
        {
            DataTable _datos = new DataTable();
            string msg_local = "", consulta = "";
            try
            {
                SqlDataAdapter _da;
                ConexionSql cn = new ConexionSql();
                consulta = "select T.TRANSFERENCIA_ID,COUNT(TD.SUPERSACO_ID) as SS_ASIGNADOS,T.TRANSFERENCIA_FECHA, " +
                    " IFOR.ALMACEN_MSP_DESCRIPCION as ORIGEN,IFDE.ALMACEN_MSP_DESCRIPCION as DESTINO " +
                    " from TRANSFERENCIA as T " +
                    " inner join INVENTARIO_FRIMEX as IFOR on T.ALMACEN_ORIGEN_ID = IFOR.INVENTARIO_FRIMEX_ID " +
                    " inner join INVENTARIO_FRIMEX as IFDE on T.ALMACEN_DESTINO_ID = IFDE.INVENTARIO_FRIMEX_ID " +
                    " inner join TRANSFERENCIA_DETALLE as TD on T.TRANSFERENCIA_ID = TD.TRANSFERENCIA_ID " +
                    " inner join SUPERSACO as s on TD.SUPERSACO_ID = S.SUPERSACO_ID " +
                    " inner join PRODUCTO as p  on s.PRODUCTO_ID = p.PRODUCTO_ID or s.PRODUCTO_ID = p.PRODUCTO_MSP_ID " +
                    " where T.TRANSFERENCIA_ESTATUS = '"+ESTATUS+"' and cast(t.TRANSFERENCIA_FECHA as date) between '"+FInicio.ToString("dd-MM-yyyy")+"' and '"+FFin.ToString("dd-MM-yyyy") +"' " +
                    " group by T.TRANSFERENCIA_ID,T.TRANSFERENCIA_FECHA,IFOR.ALMACEN_MSP_DESCRIPCION,IFDE.ALMACEN_MSP_DESCRIPCION,p.PRODUCTO_DESCRIPCION";
                cn.ConectarSQLServer();
                _da = new SqlDataAdapter(consulta, cn.SC);
                _da.Fill(_datos);
                _da.Dispose();
                cn.Desconectar();
            }
            catch(Exception Ex)
            {
                msg_local = Ex.Message;
            }
            msg = msg_local;
            return _datos;
        }
    }
}
