using System;
using System.Collections.Generic;
using System.ComponentModel;
using System.Data;
using System.Drawing;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
using System.Windows.Forms;
using System.Data.SqlClient;

namespace FrimexTransferencia
{
    public partial class FRep : Form
    {
        public FRep()
        {
            InitializeComponent();
        }
        public UsuariosC _Usuario = new UsuariosC();

        private void bGenerar_Click(object sender, EventArgs e)
        {
            string aux = cBSeleccionReporte.SelectedItem.ToString();
            if(aux.Length>0)
            {
                DateTime _fechaInicio = dTPInicio.Value, _fechaFin = dTPFin.Value;
                C_REPORTES _reporte = new C_REPORTES();
                        string consulta = "", msg_local = "", _periodo = "Del " + _fechaInicio.ToString("dd/MM/yyyy") + " al " + _fechaFin.ToString("dd/MM/yyyy"); ;


            if (aux == "Reporte de pesos de supersacos")
                consulta= "SELECT S.SUPERSACO_ID,P.PRODUCTO_DESCRIPCION,HSSP.SUPERSACO_CANTIDAD as CANT_ANTERIOR,s.SUPERSACO_CANTIDAD as ULTIMA_CANT, hssp.FECHA_ACTUALIZACION " +
                                " FROM SUPERSACO AS S " +
                                " INNER JOIN PRODUCTO AS P ON S.PRODUCTO_ID = P.PRODUCTO_ID OR S.SUPERSACO_ID = P.PRODUCTO_MSP_ID " +
                                " INNER JOIN HIST_SS_PESO AS HSSP ON S.SUPERSACO_ID = HSSP.SUPERSACO_ID " +
                                " where " +
                                " HSSP.SUPERSACO_CANTIDAD<> S.SUPERSACO_CANTIDAD " +
                                //" or HSSP.SUPERSACO_CANTIDAD = s.SUPERSACO_CANTIDAD " +
                                " and HSSP.FECHA_ACTUALIZACION between '" + _fechaInicio.ToString("dd/MM/yyyy") + " " + dTPInicioHora.Value.ToString("HH:mm:ss") +
                                "' AND '" + _fechaFin.ToString("dd/MM/yyyy") + " " + dTPFechaFinHora.Value.ToString("HH:mm:ss") + "'";                
            else if (aux == "Reporte de transferencias detallado")
                consulta= "Select R.REQUISICION_ID as [NO REQUISICION],R.REQUISICION_FECHA AS [FECHA REQUISICION],IVO.ALMACEN_MSP_DESCRIPCION as [ALMACEN ORIGEN] " +
                        " ,IVD.ALMACEN_MSP_DESCRIPCION AS[ALMACEN DESTINO], T.TRANSFERENCIA_ID AS[NO TRANSFERENCIA], t.TRANSFERENCIA_FECHA AS[FECHA TRANSFERENCIA] " +
                        " , S.SUPERSACO_ID AS SUPERSACO,P.PRODUCTO_DESCRIPCION AS PRODUCTO,S.SUPERSACO_CANTIDAD AS CANTIDAD " +
                        " from TRANSFERENCIA as T " +
                        " inner join TRANSFERENCIA_DETALLE as TD on Td.TRANSFERENCIA_ID = T.TRANSFERENCIA_ID " +
                        " inner join SUPERSACO as s on Td.SUPERSACO_ID = s.SUPERSACO_ID " +
                        " inner join PRODUCTO AS P ON S.PRODUCTO_ID = P.PRODUCTO_ID OR S.PRODUCTO_ID = P.PRODUCTO_MSP_ID " +
                        " inner join INVENTARIO_FRIMEX as IVO on T.ALMACEN_ORIGEN_ID = IVO.INVENTARIO_FRIMEX_ID " +
                        " inner join INVENTARIO_FRIMEX as IVD on T.ALMACEN_DESTINO_ID = IVD.INVENTARIO_FRIMEX_ID " +
                        " INNER JOIN REQ_TRA AS RT ON RT.TRANSFERENCIA_ID = T.TRANSFERENCIA_ID " +
                        " INNER JOIN REQUISICION AS R ON RT.REQUISICION_ID = R.REQUISICION_ID " +
                        " INNER JOIN REQUISICION_DETALLE AS RD ON R.REQUISICION_ID = RD.REQUISICION_ID " +
                        " where T.TRANSFERENCIA_FECHA between '" + _fechaInicio.ToString("dd/MM/yyyy") + " " + dTPInicioHora.Value.ToString("HH:mm:ss") +
                        "' AND '" + _fechaFin.ToString("dd/MM/yyyy") + " " + dTPFechaFinHora.Value.ToString("HH:mm:ss") + "'";
                else if (aux == "Reporte Supersacos disponibles por ubicacion")
                    consulta = "select ifo.ALMACEN_MSP_DESCRIPCION,p.PRODUCTO_DESCRIPCION,s.SUPERSACO_ID " +
                        " ,s.SUPERSACO_CANTIDAD,s.SUPERSACO_FECHA,poc.FOLIO,s.LOTE_ID " +
                        " from  SUPERSACO as s " +
                        " inner join PRODUCTO AS P ON S.PRODUCTO_ID = P.PRODUCTO_ID OR S.PRODUCTO_ID = P.PRODUCTO_MSP_ID " +
                        " inner join INVENTARIO_SUPERSACO as iss on s.INVENTARIO_SUPERSACO_ID = iss.INVENTARIO_SUPERSACO_ID " +
                        " inner join INVENTARIO_FRIMEX as ifo on iss.INVENTARIO_FRIMEX_ID = ifo.INVENTARIO_FRIMEX_ID " +
                        " left join EMBARQUE as e on s.EMBARQUE_ID=e.EMBARQUE_ID"+
                        " left join PETICION_OC as POC on e.EMBARQUE_DOCUMENTO_ID = poc.PETICION_OC_ID" +
                        " where s.SUPERSACO_ESTATUS = 'A' " +
                        " and  Cast(S.SUPERSACO_FECHA as date)>'31-12-2019'" +
                        " order by ALMACEN_MSP_DESCRIPCION,p.PRODUCTO_DESCRIPCION,s.SUPERSACO_ID";
                else if (aux == "Reporte tranferencias por rango de fechas")
                    consulta = "select IVO.ALMACEN_MSP_DESCRIPCION AS ORIGEN,IVD.ALMACEN_MSP_DESCRIPCION AS DESTINO,t.TRANSFERENCIA_ID "+
                        " ,P.PRODUCTO_DESCRIPCION,COUNT(tD.SUPERSACO_ID) AS CANT_SUPERSACOS "+
                        " from TRANSFERENCIA AS T "+
                        " inner join TRANSFERENCIA_DETALLE as TD on Td.TRANSFERENCIA_ID = T.TRANSFERENCIA_ID "+
                        " inner join INVENTARIO_FRIMEX as IVO on T.ALMACEN_ORIGEN_ID = IVO.INVENTARIO_FRIMEX_ID "+
                        " inner join INVENTARIO_FRIMEX as IVD on T.ALMACEN_DESTINO_ID = IVD.INVENTARIO_FRIMEX_ID "+
                        " INNER JOIN SUPERSACO AS S ON TD.SUPERSACO_ID = S.SUPERSACO_ID "+
                        " INNER JOIN PRODUCTO AS P ON S.PRODUCTO_ID = P.PRODUCTO_ID OR S.SUPERSACO_ID = P.PRODUCTO_MSP_ID "+
                        " where "+
                        " T.TRANSFERENCIA_FECHA between '" + _fechaInicio.ToString("dd/MM/yyyy") + " " + dTPInicioHora.Value.ToString("HH:mm:ss") +
                        "' AND '" + _fechaFin.ToString("dd/MM/yyyy") + " " + dTPFechaFinHora.Value.ToString("HH:mm:ss") + "'"+
                        " GROUP BY IVO.ALMACEN_MSP_DESCRIPCION ,IVD.ALMACEN_MSP_DESCRIPCION ,t.TRANSFERENCIA_ID,P.PRODUCTO_DESCRIPCION " +
                        " ORDER BY T.TRANSFERENCIA_ID";
                if (_fechaInicio < _fechaFin||aux== "Reporte Supersacos disponibles por ubicacion")
                {
                    DialogResult _resp = MessageBox.Show("¿Desea exportar la infomacion a Excel?", "Confirmación", MessageBoxButtons.YesNo, MessageBoxIcon.Question);
                    if (_resp == DialogResult.Yes)
                    {
                        try
                        {
                             ConexionSql con = new ConexionSql();
                            try
                            {
                                con.ConectarSQLServer();
                            }
                            catch (Exception ex)
                            {
                                msg_local = ex.Message;
                                MessageBox.Show("Hubo un error al conectar con la base de datos, verifique la red", "Error", MessageBoxButtons.OK, MessageBoxIcon.Error);
                                return;
                            }
                            SqlDataAdapter _da = new SqlDataAdapter(consulta, con.SC);
                            DataTable datos = new DataTable();
                            _da.Fill(datos);
                            if (aux == "Reporte Supersacos disponibles por ubicacion")
                            {
                                DataTable _datosFolio = new DataTable();
                                //Agrupar FOLIO  ALMACEN	SUPERSACO_ID	PRODUCTO	PESO_KG	FOLIO	LOTE_ID	FECHA_CREACION

                                _datosFolio.Columns.Add("ALMACEN", typeof(string));
                                _datosFolio.Columns.Add("SUPERSACO_ID", typeof(int));
                                _datosFolio.Columns.Add("PRODUCTO", typeof(string));
                                _datosFolio.Columns.Add("CANTIDAD", typeof(double));
                                _datosFolio.Columns.Add("FOLIO", typeof(string));
                                _datosFolio.Columns.Add("FECHA_CREACION", typeof(string));
                                foreach (DataRow row in datos.Rows)
                                {
                                    int _SSID = 0, _FOLIO = 0;
                                    double _CANTIDAD = 0.0;
                                    string  _FECHA = "",_ALMACEN = "",_aux = "", _PRODDESC = "";

                                    if (string.IsNullOrEmpty(Convert.ToString(row["ALMACEN_MSP_DESCRIPCION"])))
                                        _ALMACEN = "";
                                    else
                                        _ALMACEN = Convert.ToString(row["ALMACEN_MSP_DESCRIPCION"]);

                                    if (string.IsNullOrEmpty(row["SUPERSACO_ID"].ToString()))
                                        _SSID = -1;
                                    else
                                       _SSID = Convert.ToInt32(row["SUPERSACO_ID"]);

                                    if (string.IsNullOrEmpty(row["SUPERSACO_CANTIDAD"].ToString()))
                                        _CANTIDAD = 0;
                                    else
                                        _CANTIDAD = Convert.ToDouble(row["SUPERSACO_CANTIDAD"]);
                                    
                                    _PRODDESC = Convert.ToString(row["PRODUCTO_DESCRIPCION"]);

                                    _aux = Convert.ToString(row["FOLIO"]);
                                    if (_aux.Length == 0)
                                        _aux = Convert.ToString(row["LOTE_ID"]);
                                    _FOLIO = Convert.ToInt32(_aux);

                                    if (string.IsNullOrEmpty(Convert.ToString(row["SUPERSACO_FECHA"])))
                                        _FECHA = "";
                                    else
                                        _FECHA = Convert.ToDateTime(row["SUPERSACO_FECHA"]).ToString("dd/MM/yyyy HH:mm:ss");
                                   

                                    _datosFolio.Rows.Add(_ALMACEN, _SSID, _PRODDESC, _CANTIDAD, _FOLIO, _FECHA);
                                }
                                datos = new DataTable();
                                datos =_datosFolio;
                            }

                                if (datos.Rows.Count > 0)
                            {
                                DataGridView _datosConsulta = new DataGridView();
                                //asingar datos de la consulta al nuevo grid
                                foreach (DataColumn _columna in datos.Columns)
                                {
                                    _datosConsulta.Columns.Add(_columna.ColumnName, _columna.ColumnName);
                                }
                                int j = 0;
                                foreach (DataRow _fila in datos.Rows)
                                {
                                    _datosConsulta.Rows.Add();
                                    Color color = Color.White;
                                    if (j % 2 == 0)
                                        color = Color.White;
                                    else
                                        color = Color.LightCyan;
                                    _datosConsulta.Rows[j].DefaultCellStyle.BackColor = color;
                                    for (int i = 0; i < datos.Columns.Count; i++)
                                    {
                                        string aux2 = Convert.ToString(_fila[i]);
                                        if (aux2.Length == 0)
                                            aux2 = "0.0";
                                        _datosConsulta[i, j].Value = aux2;
                                    }
                                    j++;
                                }
                                _datosConsulta.Rows.Add();
                                string ruta = _reporte.ExportarDataGridViewExcel(aux, "", pb, sFDGuardar, _datosConsulta, _Usuario.USUARIO, _periodo, out msg_local);
                                if (ruta.Length > 0)
                                    MessageBox.Show("Archivo generado con éxito\n\r\"" + ruta + "\"", "Éxito", MessageBoxButtons.OK, MessageBoxIcon.Information);
                            }
                            else
                                MessageBox.Show("Sin datos encontrados", "Información");
                        }
                        catch (Exception Ex)
                        {
                            msg_local = Ex.Message;
                        }
                        if (msg_local.Length > 0)
                            MessageBox.Show(msg_local, "Error");
                    }
                }
            }
        }
        private void PesosSS()
        {
            DateTime _fechaInicio = dTPInicio.Value, _fechaFin = dTPFin.Value;
            if (_fechaInicio < _fechaFin)
            {
                DialogResult _resp = MessageBox.Show("¿Desea exportar la infomacion a Excel?", "Confirmación", MessageBoxButtons.YesNo, MessageBoxIcon.Question);
                if (_resp == DialogResult.Yes)
                {
                    C_REPORTES _reporte = new C_REPORTES();
                    string consulta = "", msg_local = "", _periodo = "Del " + _fechaInicio.ToString("dd/MM/yyyy") + " al " + _fechaFin.ToString("dd/MM/yyyy"); ;

                    try
                    {
                        consulta = "SELECT S.SUPERSACO_ID,P.PRODUCTO_DESCRIPCION,HSSP.SUPERSACO_CANTIDAD as CANT_ANTERIOR,s.SUPERSACO_CANTIDAD as ULTIMA_CANT, hssp.FECHA_ACTUALIZACION " +
                            " FROM SUPERSACO AS S " +
                            " INNER JOIN PRODUCTO AS P ON S.PRODUCTO_ID = P.PRODUCTO_ID OR S.SUPERSACO_ID = P.PRODUCTO_MSP_ID " +
                            " INNER JOIN HIST_SS_PESO AS HSSP ON S.SUPERSACO_ID = HSSP.SUPERSACO_ID " +
                            " where " +
                            " HSSP.SUPERSACO_CANTIDAD<> S.SUPERSACO_CANTIDAD " +
                            //" or HSSP.SUPERSACO_CANTIDAD = s.SUPERSACO_CANTIDAD " +
                            " and HSSP.FECHA_ACTUALIZACION between '"+ _fechaInicio.ToString("dd/MM/yyyy")+" " +dTPInicioHora.Value.ToString("HH:mm:ss")+
                            "' AND '" +_fechaFin.ToString("dd/MM/yyyy")+ " "+dTPFechaFinHora.Value.ToString("HH:mm:ss")+"'";
                        ConexionSql con = new ConexionSql();
                        try
                        {
                            con.ConectarSQLServer();
                        }
                        catch (Exception ex)
                        {
                            msg_local = ex.Message;
                            MessageBox.Show("Hubo un error al conectar con la base de datos, verifique la red", "Error", MessageBoxButtons.OK, MessageBoxIcon.Error);
                            return;
                        }
                        SqlDataAdapter _da = new SqlDataAdapter(consulta, con.SC);
                        DataTable datos = new DataTable();
                        _da.Fill(datos);
                        if (datos.Rows.Count > 0)
                        {
                            DataGridView _datosConsulta = new DataGridView();
                            //asingar datos de la consulta al nuevo grid
                            foreach (DataColumn _columna in datos.Columns)
                            {
                                _datosConsulta.Columns.Add(_columna.ColumnName, _columna.ColumnName);
                            }
                            int j = 0;
                            foreach (DataRow _fila in datos.Rows)
                            {
                                _datosConsulta.Rows.Add();
                                Color color = Color.White;
                                if (j % 2 == 0)
                                    color = Color.White;
                                else
                                    color = Color.LightCyan;
                                _datosConsulta.Rows[j].DefaultCellStyle.BackColor = color;
                                for (int i = 0; i < datos.Columns.Count; i++)
                                {
                                    string aux = Convert.ToString(_fila[i]);
                                    if (aux.Length == 0)
                                        aux = "0.0";
                                    _datosConsulta[i, j].Value = aux;
                                }
                                j++;
                            }
                            _datosConsulta.Rows.Add();
                            string ruta = _reporte.ExportarDataGridViewExcel("Reporte de Metas de Ventas", "", pb, sFDGuardar, _datosConsulta, _Usuario.USUARIO, _periodo, out msg_local);
                            if (ruta.Length > 0)
                                MessageBox.Show("Archivo generado con éxito\n\r\"" + ruta + "\"", "Éxito", MessageBoxButtons.OK, MessageBoxIcon.Information);
                        }
                        else
                            MessageBox.Show("Sin datos encontrados", "Información");
                    }
                    catch (Exception Ex)
                    {
                        msg_local = Ex.Message;
                    }
                    if (msg_local.Length > 0)
                        MessageBox.Show(msg_local, "Error");
                }
            }
        }
        private void TranferenciasDetallado()
        {

            string msg_local = "";
            try
            {

            }
            catch (Exception Ex)
            {
                msg_local = Ex.Message;
            }
            if (msg_local.Length > 0)
                MessageBox.Show(msg_local, "Error");
        }
        private void SupersacosDisponiblesXUbicacion()
        {

            string msg_local = "";
            try
            {

            }
            catch (Exception Ex)
            {
                msg_local = Ex.Message;
            }
            if (msg_local.Length > 0)
                MessageBox.Show(msg_local, "Error");
        }
        private void TransferenciasXFechas()
        {

            string msg_local = "";
            try
            {

            }
            catch (Exception Ex)
            {
                msg_local = Ex.Message;
            }
            if (msg_local.Length > 0)
                MessageBox.Show(msg_local, "Error");
        }
    }
}
